# IP 相当于OSI参考模型的第3层

网络层的主要作用是“实现终端节点之间的通信”。 这种终端节点之间的通信也叫“点对点（end-to-end）通信”。  

数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递。 而一旦跨越多种数据链路， 就需要借助网络层。 网络层可以跨越不同的数据链路， 即使是在不同的数据链路上也能实现两端节点之间的数据包传输。  

![](./img/ip_effect.png)

## 主机与节点  

在互联网世界中， 将那些配有IP地址的设备叫做“主机”。然而， 准确地说， 主机的定义应该是指“配置有IP地址， 但是不进行路由控制的设备”。   

既配有IP地址又具有路由控制能力的设备叫做“路由器”， 跟主机有所区别。   

节点则是主机和路由器的统称。 

在IPv4的规范RFC791中， 将具有路由控制功能的设备叫做“ 网关” ， 然而现在都普遍叫做路由器（或3层交换机） 。 ） 。    

## 网络层与数据链路层的关系  

数据链路层提供直连两个设备之间的通信功能。 与之相比， 作为网络层的IP则负责在没有直连的两个网络之间进行通信传输。   

![](./img/ip_data_link.png)

# IP基础知识  

IP大致分为三大作用模块， 它们是IP寻址、 路由（最终节点为止的转发） 以及IP分包与组包。  

## IP地址属于网络层地址  

在计算机通信中， 为了识别通信对端， 必须要有一个类似于地址的识别码进行标识。MAC地址正是用来标识同一个链路中不同计算机的一种识别码。作为网络层的IP， 也有这种地址信息。 一般叫做IP地址。 IP地址用于在“连接到网络中的所有主机中识别出进行通信的目标地址”。 因此， 在TCP/IP通信中所有主机或路由器必须设定自己的IP地址。

![](./img/ip_address.png)

 不论一台主机与哪种数据链路连接， 其IP地址的形式都保持不变。 以太网、 无线局域网、 PPP等， 都不会改变IP地址的形式（数据链路的MAC地址的形式不一定必须一致。 ） 。

另外， 在网桥或交换集线器等物理层或数据链路层数据包转发设备中， 不需要设置IP地址。 因为这些设备只负责将IP包转化为0、 1比特流转发或对数据链路帧的数据部分进行转发， 而不需要应对IP协议（反之， 这些设备既可以在IPv4环境中使用， 也可以在IPv6环境中使用。 ） 。    

## 路由控制  

路由控制（Routing） 是指将分组数据发送到最终目标地址的功能。 即使网络非常复杂， 也可以通过路由控制确定到达目标地址的通路。 一旦这个路由控制的运行出现异常， 分组数据极有可能“迷失”， 无法到达目标地址。 因此， 一个数据包之所以能够成功地到达最终的目标地址， 全靠路由控制。  

![](./img/routing.png)

### 发送数据至最终目标地址  

Hop译为中文叫“跳”。 它是指网络中的一个区间。 IP包正是在网络中一个个跳间被转发。 因此IP路由也叫做多跳路由。 在每一个区间内决定着包在下一跳被转发的路径。  

![](./img/multi_hop_routing.png)

一跳（1 Hop） 是指利用数据链路层以下分层的功能传输数据帧的一个区间。  

以太网等数据链路中使用MAC地址传输数据帧。 此时的一跳是指从源MAC地址到目标MAC地址之间传输帧的区间。 也就是说它是主机或路由器网卡不经其他路由器而能直接到达的相邻主机或路由器网卡之间的一个区间。 在一跳的这个区间内， 电缆可以通过网桥或交换集线器相连， 不会通过路由器或网关相连。  

多跳路由是指路由器或主机在转发IP数据包时只指定下一个路由器或主机， 而不是将到最终目标地址为止的所有通路全都指定出来。 因为每一个区间（跳） 在转发IP数据包时会分别指定下一跳的操作， 直至包达到最终的目标地址。    

![](./img/ip_package_sending.png)

### 路由控制表  

为了将数据包发给目标主机， 所有主机都维护着一张路由控制表（Routing Table） 。 该表记录IP数据在下一步应该发给哪个路由器。 IP包将根据这个路由表在各个数据链路上传输。  

![](./img/routing_table.png)

## 数据链路的抽象化  

IP是实现多个数据链路之间通信的协议。 数据链路根据种类的不同各有特点。 对这些不同数据链路的相异特性进行抽象化也是IP的重要作用之一。  数据链路的地址可以被抽象化为IP地址。因此， 对IP的上一层来说， 不论底层数据链路使用以太网还是无线LAN亦或是PPP， 都将被一视同仁。  

不同数据链路有个最大的区别， 就是它们各自的最大传输单位（MTU： Maximum Transmission Unit） 不同。

![](./img/diff_data_link.png)   

MTU的值在以太网中是1500字节， 在FDDI中是4352字节， 而ATM则为9180字节。 IP的上一层可能会要求传送比这些MTU更多字节的数据， 因此必须在线路上传送比包长还要小的MTU。  

为了解决这个问题， IP进行分片处理（IP Fragmentation） 。 顾名思义， 所谓分片处理是指， 将较大的IP包分成多个较小的IP包。 分片的包到了对端目标地址以后会再被组合起来传给上一层。 即从IP的上次层看， 它完全可以忽略数据包在途中的各个数据链路上的MTU，而只需要按照源地址发送的长度接收数据包。 IP就是以这种方式抽象化了数据链路层， 使得从上层更不容易看到底层网络构造的细节。  

## IP属于面向无连接型  

IP面向无连接。 即在发包之前， 不需要建立与对端目标地址之间的连接。 上层如果遇到需要发送给IP的数据， 该数据会立即被压缩成IP包发送出去。  

即使对端主机关机或不存在， 数据包还是会被发送出去。 反之， 对于一台主机来说， 它会何时从哪里收到数据也是不得而知的。 通常应该进行网络监控， 让主机只接收发给自己的数据包。 若没有做好准备很有可能会错过一些该收的包。 因此， 在面向无连接的方式下可能会有很多冗余的通信。  

### 为什么IP要采用面向无连接呢？  

主要有两点原因：

- 一是为了简化，面向连接比起面向无连接处理相对复杂。 甚至管理每个连接本身就是一个相当繁琐的事情
- 二是为了提速，此外， 每次通信之前都要事先建立连接， 又会降低处理速度。 需要有连接时， 可以委托上一层提供此项服务。 因此， IP为了实现简单化与高速化采用面向无连接的方式

# IP地址的基础知识  

在用TCP/IP通信时， 用IP地址识别主机和路由器。 为了保证正常通信， 有必要为每个设备配置正确的IP地址。 在互联网通信中， 全世界都必须设定正确的IP地址。 否则， 根本无法实现正常的通信。因此， IP地址就像是TCP/IP通信的一块基石。  

## IP地址的定义  

IP地址（IPv4地址） 由32位正整数来表示。 TCP/IP通信要求将这样的IP地址分配给每一个参与通信的主机。 IP地址在计算机内部以二进制（二进制是指用0、 1表示数字的方法。 ） 方式被处理。但是习惯上使用 “ 十进制点符号”  表示。

![](./img/ipv4_presentation.png)   

因此，对于 IPV4 最多可以允许43亿台计算机连接到网络。

实际上， IP地址并非是根据主机台数来配置的， 而是每一台主机上的每一块网卡（NIC） 都得设置IP地址。 通常一块网卡只设置一个IP地址， 其实一块网卡也可以配置多个IP地址。 此外， 一台路由器通常都会配置两个以上的网卡， 因此可以设置两个以上的IP地址。    

![](./img/ip_assignment.png)

## IP地址由网络和主机两部分标识组成  

IP地址由“网络标识（网络地址） ”和“主机标识（主机地址） ”两部分组成。

![](./img/ip_host_identifiction.png)

![](./img/ip_network_identification.png)

网络标识在数据链路的每个段配置不同的值。 网络标识必须保证相互连接的每个段的地址不相重复。 而相同段内相连的主机必须有相同的网络地址。 IP地址的“主机标识”则不允许在同一个网段内重复出现。  

## IP地址的分类  

IP地址分为四个级别， 分别为A类、 B类、 C类、 D类（还有一个一直未使用的E类。 ） 。 它根据IP地址中从第1位到第4位的比特列对其网络标识和主机标识进行区分。  

![](./img/ip_address_classfication.png)

### A类地址  

A类IP地址是首位以“0”开头的地址。 从第1位到第8位（去掉分类位剩下7位。 ） 是它的网络标识。 用十进制表示的话， 0.0.0.0～127.0.0.0是A类的网络地址。 A类地址的后24位相当于主机标识。 因此， 一个网段内可容纳的主机地址上限为16， 777， 214个。

### B类地址  

B类IP地址是前两位为“10”的地址。 从第1位到第16位（去掉分类位剩下14位。 ） 是它的网络标识。 用十进制表示的话， 128.0.0.1～191.255.0.0是B类的网络地址。 B类地址的后16位相当于主机标识。 因此， 一个网段内可容纳的主机地址上限为65， 534个。  

### C类地址
C类IP地址是前三位为“110”的地址。 从第1位到第24位（去掉分类位剩下21位。 ） 是它的网络标识。 用十进制表示的话， 192.168.0.0～239.255.255.0是C类的网络地址。 C类地址的后8位相当于主机标识。 因此，一个网段内可容纳的主机地址上限为254个。  

### D类地址
D类IP地址是前四位为“1110”的地址。 从第1位到第32位（去掉分类位剩下28位。 ） 是它的网络标识。用十进制表示的话， 224.0.0.0～239.255.255.255是D类的网络地址。 D类地址没有主机标识， 常被用于多播。    

### 关于分配IP主机地址的注意事项  

在分配IP地址时关于主机标识有一点需要注意。 即要用比特位表示主机地址时， 不可以全部为0或全部为1。 因为全部为只有0在表示对应的网络地址或IP地址不可获知的情况下才使用。 而全部为1的主机地址通常作为广播地址。因此， 在分配过程中， 应该去掉这两种情况。     

## 广播地址  

广播地址用于在同一个链路中相互连接的主机之间发送数据包。 将IP地址中的主机地址部分全部设置为1， 就成为了广播地址。 例如把172.20.0.0/16用二进制表示如下：  

```
10101100.00010100.00000000.00000000
```

将这个地址的主机部分全部改为1， 则形成广播地址：  

```
10101100.00010100.11111111.11111111
```

再将这个地址用十进制表示， 则为 172.20.255.255。  

### 两种广播  

广播分为本地广播和直接广播两种。

在本网络内的广播叫做本地广播。 例如网络地址为192.168.0.0/24的情况下， 广播地址是192.168.0.255。因为这个广播地址的IP包会被路由器屏蔽， 所以不会到达192.168.0.0/24以外的其他链路上。  

在不同网络之间的广播叫做直接广播。 例如网络地址为192.168.0.0/24的主机向192.168.1.255/24的目标地址发送IP包。 收到这个包的路由器， 将数据转发给192.168.1.0/24， 从而使得所有192.168.1.1～192.168.1.254的主机都能收到这个包（由于直接广播有一定的安全问题， 多数情况下会在路由器上设置为不转发。 ） 。  

![](./img/local_direct_broadcast.png)

## IP多播  

多播用于将包发送给特定组内的所有主机。 由于其直接使用IP协议， 因此也不存在可靠传输。  

由于广播无法穿透路由， 若想给其他网段发送同样的包， 就不得不采取另一种机制。 因此， 多播这种既可以穿透路由器， 又可以实现只给那些必要的组发送数据包的技术就成为必选之路了。  

![](./img/broadcast.png)

### IP多播与地址  

多播使用D类地址。 因此， 如果从首位开始到第4位是“1110”， 就可以认为是多播地址。 而剩下的28位可以成为多播的组编号。  

![](./img/multi_broadcast.png)

从224.0.0.0到239.255.255.255都是多播地址的可用范围。 其中从224.0.0.0到224.0.0.255的范围不需要路由控制， 在同一个链路内也能实现多播。 而在这个范围之外设置多播地址会给全网所有组内成员发送多播的包（可以利用生存时间（TTL， Time To Live） 限制包的到达范围。 ） 。  

此外， 对于多播， 所有的主机（路由器以外的主机和终端主机） 必须属于224.0.0.1的组， 所有的路由器必须属于224.0.0.2的组。 类似地， 多播地址中有众多已知的地址， 它们中具有代表性的部分：

![](./img/multi_broadcast_address.png)

## 子网掩码  

一个IP地址只要确定了其分类， 也就确定了它的网络标识和主机标识。 例如A类地址前8位（除首位“0”还有7位） 、 B类地址前16位（除首位“10”还有14位） 、 C类地址前24位（除首位“110”还有21位） 分别是它们各自的网络标识部分。  

![](./img/ABC_IP.png)

网络标识相同的计算机必须同属于同一个链路。  例如， 架构B类IP网络时， 理论上一个链路内允许6万5千多台计算机连接。 然而， 在实际网络架构当中， 一般不会有在同一个链路上连接6万5千多台计算机的情况。 因此， 这种网络结构实际上是不存在的。因此， 直接使用A类或B类地址， 确实有些浪费。      

### 子网与子网掩码  

现在， 一个IP地址的网络标识和主机标识已不再受限于该地址的类别， 而是由一个叫做“子网掩码”的识别码通过子网网络地址细分出比A类、 B类、 C类更小粒度的网络。 这种方式实际上就是将原来A类、 B类C类等分类中的主机地址部分用作子网地址， 可以将原网络分为多个物理网络的一种机制。  

自从引入了子网以后， 一个IP地址就有了两种识别码。 一是IP地址本身， 另一个是表示网络部的子网掩码。 子网掩码用二进制方式表示的话， 也是一个32位的数字。 它对应IP地址网络标识部分的位全部为“1”，对应IP地址主机标识的部分则全部为“0”。 由此， 一个IP地址可以不再受限于自己的类别， 而是可以用这样的子网掩码自由地定位自己的网络标识长度。 当然， 子网掩码必须是IP地址的首位开始连续的“1”。

对于子网掩码， 目前有两种表示方式。 以172.20.100.52的前26位是网络地址的情况为例， 以下是其中一种表示方法， 它将IP地址与子网掩码的地址分别用两行来表示。  

![](./img/subnet.png)

另一种表示方式如下所示。 它在每个IP地址后面追加网络地址的位数（这种方式也叫“ 后缀” 表示法。 ） 用“/”隔开。  

![](./img/subnet2.png)

不难看出， 在第二种方式下记述网络地址时可以省略后面的“0”。 例如172.20.0.0/16跟172.20/16其实是一个意思。  

![](./img/subnet3.png)

## CIDR与VLSM  

采用任意长度分割IP地址的网络标识和主机标识。 这种方式叫做CIDR，根据CIDR， 连续多个C类地址（CIDR汇总的C类地址以2的幂次（4， 8， 16， 32， ……） 划分， 因此必须有一个能够按位分割的边界。 ） 就可以划分到一个较大的网络内。   

应用CIDR技术将203.183.224.1到203.183.225.254的地址合为同一个网络（它们本来是2个C类地址） 。  

![](./img/cidr.png)

将202.244.160.1到202.244.167.254的地址合并为一个网络的情形。 该例子中实际上是将8个C类地址合并为一个网络。  

![](./img/cidr2.png)

VLSM（可变长子网掩码）（Variable Length Subnet Mask） 。 它可以通过域间路由协议转换为RIP2 以及OSPF实现。 根据VLSM可以将网络地址划分为主机数为500个时子网掩码长度为/23， 主机数为50个时子网掩码长度为/26。 从而在理论上可以将IP地址的利用率提高至50％。  

## 全局地址与私有地址  

随着互联网的迅速普及， IP地址不足的问题日趋显著。 如果一直按照现行的方法采用唯一地址的话， 会有IP地址耗尽的危险。于是就出现了一种新技术。 它不要求为每一台主机或路由器分配一个固定的IP地址， 而是在必要的时候只为相应数量的设备分配唯一的IP地址。  

尤其对于那些没有连接互联网的独立网络中的主机， 只要保证在这个网络内地址唯一， 可以不用考虑互联网即可配置相应的IP地址。 不过， 即使让每个独立的网络各自随意地设置IP地址， 也可能会有问题。 于是又出现了私有网络的IP地址。 它的地址范围如下：



