# 路由控制的定义  

## IP地址与路由控制  

互联网是由路由器连接的网络组合而成的。 为了能让数据包正确达地到达目标主机， 路由器必须在途中进行正确地转发。 这种向“正确的方向”转发数据所进行的处理就叫做路由控制或路由。  

路由器根据路由控制表（Routing Table） 转发数据包。 它根据所收到的数据包中目标主机的IP地址与路由控制表的比较得出下一个应该接收的路由器。 因此， 这个过程中路由控制表的记录一定要正确无误。 但凡出现错误， 数据包就有可能无法到达目标主机。  

## 静态路由与动态路由  

路由控制分静态（Static Routring） 和动态（Dynamic Routing） 两种类型。静态路由是指事先设置好路由器和主机中并将路由信息固定的一种方法。 而动态路由是指让路由协议在运行过程中自动地设置路由控制信息的一种方法。 这些方法都有它们各自的利弊。  

![](./img/static_dynamic_routing.png)

静态路由给管理者带来很大的负担， 这是其一。 还有一个不可忽视的问题是， 一旦某个路由器发生故障， 基本上无法自动绕过发生故障的节点， 只有在管理员手工设置以后才能恢复正常。  

使用动态路由的情况下， 管理员必须设置好路由协议， 其设定过程的复杂程度与具体要设置路由协议的类型有直接关系。 如果有一个新的网络被追加到原有的网络中时， 只要在新增加网络的路由器上进行一个动态路由的设置即可。网络上一旦发生故障， 只要有一个可绕的其他路径， 那么数据包就会自动选择这个路径， 路由器的设置也会自动重置。       

不论是静态路由还是动态路由， 不要只使用其中一种， 可以将它们组合起来使用。  

## 动态路由的基础  

动态路由会给相邻路由器发送自己已知的网络连接信息， 而这些信息又像接力一样依次传递给其他路由器， 直至整个网络都了解时， 路由控制表也就制作完成了。 而此时也就可以正确转发IP数据包了。

![](./img/dynamic_routing.png)    

# 路由控制范围  

根据路由控制的范围常使用IGP（Interior Gateway Protocol） 和EGP（Exterior Gateway Protocol）两种类型的路由协议。  

## 自治系统与路由协议  

制定自己的路由策略， 并以此为准在一个或多个网络群体中采用的小型单位叫做自治系统（AS：Autonomous System） 或路由选择域（Routing Domain） 。  

![](./img/egp_igp.png)

自治系统（路由选择域） 内部动态路由采用的协议是域内路由协议， 即IGP。 而自治系统之间的路由控制采用的是域间路由协议， 即EGP。  

 ## IGP与EGP  

P地址分为网络部分和主机部分， 它们有各自的分功。 EGP与IGP的关系与IP地址网络部分和主机部分的关系有相似之处。 就像根据IP地址中的网络部分在网络之间进行路由选择、 根据主机部分在链路内部进行主机识别一样， 可以根据EGP在区域网络之间（或ISP之间） 进行路由选择， 也可以根据IGP在区域网络内部（或ISP内部） 进行主机识别。由此， 路由协议被分为EGP和IGP两个层次。 没有EGP就不可能有世界上各个不同组织机构之间的通信。 没有IGP机构内部也就不可能进行通信。    

IGP中还可以使用RIP（Routing Information Protocol， 路由信息协议） 、 RIP2、 OSPF（Open Shortest Path First， 开放式最短路径优先） 等众多协议。 与之相对， EGP使用的是BGP（Border Gateway Protocol， 边界网关协议） 协议。  

# 路由算法  

路由控制有各种各样的算法， 其中最具代表性的有两种， 是距离向量（Distance-Vector） 算法和链路状态（Link-State） 算法。  

## 距离向量算法  

距离向量算法（DV） 是指根据距离和方向决定目标网络或目标主机位置的一种方法。    

![](./img/dv.png)

路由器之间可以互换目标网络的方向及其距离的相关信息， 并以这些信息为基础制作路由控制表。 这种方法在处理上比较简单， 不过由于只有距离和方向的信息， 所以当网络构造变得分外复杂时， 在获得稳定的路由信息之前需要消耗一定时间（也叫做路由收敛。 ） ， 也极易发生路由循环等问题。    

## 链路状态算法  

链路状态算法是路由器在了解网络整体连接状态的基础上生成路由控制表的一种方法。 该方法中， 每个路由器必须保持同样的信息才能进行正确的路由选择。  

对于任何一台路由器， 网络拓扑都完全一样。 因此， 只要某一台路由器与其他路由器保持同样的路由控制信息， 就意味着该路由器上的路由信息是正确的。 只要每个路由器尽快地与其他路由器同步路由信息， 就可以使路由信息达到一个稳定的状态。 因此， 即使网络结构变得复杂， 每个路由器也能够保持正确的路由信息、 进行稳定的路由选择。 这也是该算法的一个优点。   

为了实现上述机制， 链路状态算法付出的代价就是如何从网络代理获取路由信息表。 这一过程相当复杂， 特别是在一个规模巨大而又复杂的网络结构中， 管理和处理代理信息需要高速CPU处理能力和大量的内存。  

![](./img/link_state.png)

## 主要路由协议  

![](./img/routing_protocol.png)

# RIP  

RIP（Routing Information Protocol） 是距离向量型的一种路由协议， 广泛用于LAN。   

## 广播路由控制信息  

RIP将路由控制信息定期（30秒一次） 向全网广播。 如果没有收到路由控制信息， 连接就会被断开。 不过， 这有可能是由于丢包导致的， 因此RIP规定等待5次。 如果等了6次（180秒） 仍未收到路由信息， 才会真正关闭连接。  

![](./img/rip.png)

## 根据距离向量确定路由  

RIP基于距离向量算法决定路径。 距离（Metrics） 的单位为“跳数”。 跳数是指所经过的路由器的个数。RIP希望尽可能少通过路由器将数据包转发到目标IP地址，根据距离向量生成距离向量表， 再抽出较小的路由生成最终的路由控制表。     

![](./img/dv_routing_table.png)

如果距离相等， 那么根据路由器的类型选择的路由也会不同， 通常是随机选择一个或是轮换使用。  

## 使用子网掩码时的RIP处理  

RIP虽然不交换子网掩码信息， 但可以用于使用子网掩码的网络环境。 不过在这种情况下需要注意以下几点：

- 从接口的IP地址对应分类得出网络地址后， 与根据路由控制信息流过此路由器的包中的IP地址对应的分类得出的网络地址进行比较。 如果两者的网络地址相同， 那么就以接口的网络地址长度为准
- 如果两者的网络地址不同， 那么以IP地址的分类所确定的网络地址长度为准  

采用RIP进行路由控制的范围内必须注意两点： 一是， 因IP地址的分类而产生不同的网络地址时； 二是， 构造网络地址长度不同的网络环境时。  

![](./img/rip_subnet.png)

当把IP地址分类表示的网络地址延长至子网掩码的长度时， 所延长的部分如果为0， 称之为0子网； 如果为1， 则称之为1子网。 需要注意的是0子网与1子网在RIP中都无法使用。   

## RIP中路由变更时的处理  

RIP的基本行为可归纳为如下两点：  

- 将自己所知道的路由信息定期进行广播  
- 一旦认为网络被断开， 数据将无法流过此路由器， 其他路由器也就可以得知网络已经断开  

不过， 这两点不论哪种方式都存在一些问题：路由器A将网络A的连接信息发送给路由器B， 路由器B又将自己掌握的路由信息在原来的基础上加1跳后发送给路由器A和路由器C。 假定这时与网络A发生了故障。 路由器A虽然觉察到自己与网络A的连接已经断开， 无法将网络A的信息发送给路由器B， 但是它会收到路由器B曾经获知的消息。 这就使得路由器A误认为自己的信息还可以通过路由器B到达网络A。  像这样收到自己发出去的消息， 这个问题被称为无限计数（Counting to Infinity） 。 为了解决这个问题可以采取以下两种方法：   

- 一是最长距离不超过16（“ 距离为16” 这个信息只会被保留120秒。 一旦超过这个时间， 信息将会被删除， 无法发送。 这个时间由一个叫做垃圾收集计时器（Garbage-collection Timer） 的工具进行管理。 ） 。 由此即使发生无限计数的问题， 也可以从时间上进行控制  
- 二是规定路由器不再把所收到的路由消息原路返还给发送端。 这也被称作水平分割（Split Horizon）  

![](./img/infinite_count.png)

![](./img/split_horizon.png)

在有环路情况下， 反向的回路会成为迂回的通道， 路由信息会不断地被循环往复地转发。 当环路内部某一处发生通信故障时， 通常可以设置一个正确的迂回通道。   

当网络A的通信发生故障时， 将无法传送正确的路由信息。 尤其是在环路有多余的情况下， 需要很长时间才能产生正确的路由信息。    

![](./img/loop_network.png)

为了尽可能解决这个问题， 人们提出了“毒性逆转”（Poisoned Reverse） 和“触发更新”（Triggered Update） 两种方法。  

毒性逆转是指当网络中发生链路被断开的时候， 不是不再发送这个消息， 而是将这个无法通信的消息传播出去。 即发送一个距离为16的消息。 触发更新是指当路由信息发生变化时， 不等待30秒而是立刻发送出去的一种方法。 有了这两种方法， 在链路不通时， 可以迅速传送消息以使路由信息尽快收敛。  

![](./img/trigger_update.png)

然而， 纵然使用了到现在为止所介绍的方法， 在一个具有众多环路的复杂的网络环境中， 路由信息想要达到一个稳定的状态是需要花一段时间的。 为了解决这个问题， 必须明确地掌握网络结构， 在了解究竟哪个链路断开后再进行路由控制非常重要。 为此， 可以采用OSPF。  

## RIP2  

它是在RIP使用过程中总结了经验的基础上进行改良后的一种协议。 第二版与第一版的工作机制基本相同， 不过仍有如下几个新的特点：

- 使用多播  

RIP中当路由器之间交换路由信息时采用广播的形式， 然而在RIP2中改用了多播。 这样不仅减少了网络的流量， 还缩小了对无关主机的影响。

-  支持子网掩码

 与OSPF类似的， RIP2支持在其交换的路由信息中加入子网掩码信息。

- 路由选择域

与OSPF的区域类似， 在同一个网络中可以使用逻辑上独立的多个RIP。

-  外部路由标志

通常用于把从BGP等获得的路由控制信息通过RIP传递给AS内。

- 身份验证密钥

  与OSPF一样， RIP包中携带密码。 只有在自己能够识别这个密码时才接收数据， 否则忽略这个RIP包。

# OSPF  

OSPF（Open Shortest Path First） 是根据OSI的IS-IS（Intermediate System to Intermediate System Intra-Domain routing information exchange protocol， 中间系统到中间系统的路由选择协议。 ） 协议而提出的一种链路状态型路由协议。 由于采用链路状态类型， 所以即使网络中有环路， 也能够进行稳定的路由控制。  

另外， OSPF支持子网掩码。 由此， 曾经在RIP中无法实现的可变长度子网构造的网络路由控制成为现实。

甚至为了减少网络流量， OSPF还引入了“区域”这一概念。 区域是将一个自治网络划分为若干个更小的范围。 由此， 可以减少路由协议之间不必要的交换。

OSPF可以针对IP首部中的区分服务（TOS） 字段， 生成多个路由控制表。 不过， 也会出现已经实现了OSPF功能的路由器无法支持这个TOS的情况。  

## OSPF是链路状态型路由协议  

